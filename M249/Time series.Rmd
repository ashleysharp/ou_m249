---
title: "Time series"
output: html_document
date: "2023-06-25"
---

```{r}
library(tidyverse)
library(janitor)
library(haven)
library(slider)
library(tsibble)
library(feasts)
library(fable)
library(fabletools)
```

# Plotting and transforming
Note: These are not isoweeks as no week 53. Starting on 1st Jan each year.
```{r}
ts_infections <- read_sav("data/Book 2/infections.sav") %>%
  mutate(date = ymd(paste0(year, "-01-01")) + weeks(week - 1),
         log_rotavirus = log(rotavirus)) %>% 
  as_tsibble(index = date)
```

## Salmonella
```{r}
ggplot(ts_infections, aes(x = date, y = salmonella)) + 
  geom_line() + 
  scale_x_date(
    breaks = make_date(year = seq(year(min(ts_infections$date)),
                                  year(max(ts_infections$date)),
                                  by = 1),
                       month = 1, day = 1),
    date_labels = "%Y"
  ) +
  theme_minimal()
```


## Rotavirus
```{r}
year_breaks <- make_date(
  year  = seq(year(min(ts_infections$date)),
              year(max(ts_infections$date)),
              by = 1),
  month = 1,
  day   = 1
)

ggplot(ts_infections, aes(x = date, y = rotavirus)) + 
  geom_line() + 
  scale_x_date(
    breaks = year_breaks,
    date_labels = "%Y"
  ) +
  theme_minimal()

ggplot(ts_infections, aes(x = date, y = log_rotavirus)) + 
  geom_line() + 
  scale_x_date(
    breaks = year_breaks,
    date_labels = "%Y"
  ) +
  theme_minimal()
```


## Airline passengers
```{r}
ts_airline <- read_sav("data/Book 2/airline.sav") %>% 
  clean_names() %>%
  mutate(
    year_month = yearmonth(sprintf("%d-%02d", year, month)),
    log_passengers = log(passengers),
    sqrt_passengers = passengers^(1/2),
    qrt_passengers = passengers^(1/4)
  ) %>%
  as_tsibble(index = year_month)
```

```{r}
ggplot(ts_airline, aes(x = year_month, y = passengers)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      vjust = 1
    )
  )

ggplot(ts_airline, aes(x = year_month, y = log_passengers)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_airline, aes(x = year_month, y = sqrt_passengers)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_airline, aes(x = year_month, y = qrt_passengers)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()
```

# Moving averages

## Temperature
```{r}
ts_alltemps <- read_sav("data/Book 2/alltemps.sav") %>% 
  clean_names() %>%
  as_tsibble(index = year) %>% 
  mutate(ma5 = slide_dbl(temperature, mean, .before = 2, .after = 2, .complete = TRUE),
         ma31 = slide_dbl(temperature, mean, .before = 15, .after = 15, .complete = TRUE))
```

```{r}
year_breaks <- seq(
  min(ts_alltemps$year),
  max(ts_alltemps$year),
  by = 25
)

temp_range <- range(ts_alltemps$temperature, na.rm = TRUE)

ggplot(ts_alltemps, aes(x = year, y = temperature)) + 
  geom_line() + 
  scale_x_continuous(breaks = year_breaks) +
  scale_y_continuous(limits = temp_range) +
  theme_minimal()

ggplot(ts_alltemps, aes(x = year, y = ma5)) + 
  geom_line() + 
  scale_x_continuous(breaks = year_breaks) +
  scale_y_continuous(limits = temp_range) +
  theme_minimal()

ggplot(ts_alltemps, aes(x = year, y = ma31)) + 
  geom_line() + 
  scale_x_continuous(breaks = year_breaks) +
  scale_y_continuous(limits = temp_range) +
  theme_minimal()
```

## Securities

```{r}
ts_securities <- read_sav("data/Book 2/securities.sav") %>% 
  clean_names() %>%
  mutate(
    year_month = yearmonth(sprintf("%d-%02d", year, month))
  ) %>%
  as_tsibble(index = year_month) %>% 
  mutate(
    ma9  = slide_dbl(yield, mean, .before = 4,  .after = 4,  .complete = TRUE),
    ma21 = slide_dbl(yield, mean, .before = 10, .after = 10, .complete = TRUE)
  )
```

```{r}
y_range <- range(ts_securities$yield, na.rm = TRUE)

ggplot(ts_securities, aes(x = year_month, y = yield)) + 
  geom_line() +
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  scale_y_continuous(limits = y_range) +
  theme_minimal()

ggplot(ts_securities, aes(x = year_month, y = ma9)) + 
  geom_line() +
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  scale_y_continuous(limits = y_range) +
  theme_minimal()

ggplot(ts_securities, aes(x = year_month, y = ma21)) + 
  geom_line() +
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  scale_y_continuous(limits = y_range) +
  theme_minimal()
```


# Decomposition

## Airline passengers

### Additive model Xt = mt + st + Wt

```{r}
weights <- c(0.5, rep(1, 11), 0.5)
weights <- weights / sum(weights)
weights
sum(weights)
```

### Estimate trend mt_hat
```{r}
ts_airline_dec <- ts_airline %>% 
  select(year, month, year_month, Xt = qrt_passengers) %>%
  mutate(
    mt_hat = slide_dbl(
      .x = Xt,
      .f = ~ weighted.mean(.x, w = weights, na.rm = TRUE),
      .before = 6,
      .after  = 6,
      .complete = TRUE))
```

### Remove trend Yt = Xt - mt_hat
Yt = Xt - mt_hat
  = mt + st + Wt - mt_hat
  = st + Wt + (mt - mt_hat)
  = st + W't
  
(where W't = Wt + (mt - mt_hat))

```{r}
ts_airline_dec <- ts_airline_dec %>% 
  mutate(Yt = Xt - mt_hat)
```

### Raw seasonal factors Fj = mean (Yt)
```{r}
ts_airline_dec <- ts_airline_dec %>% 
  group_by(month) %>%
  mutate(Fj = mean(Yt, na.rm = TRUE)) %>%
  ungroup()

ts_airline_dec %>% distinct(month, Fj)
```

### Adj. seasonal factors st_hat = Fj - F_bar
```{r}
F_bar <- ts_airline_dec %>% 
  distinct(month, Fj) %>% 
  summarise(F_bar = mean(Fj)) %>% 
  pull(F_bar)

ts_airline_dec <- ts_airline_dec %>%
  mutate(st_hat = Fj - F_bar)
```


```{r}
ts_airline_season <- ts_airline_dec %>% distinct(month, Fj, F_bar, sj_hat = st_hat)
ts_airline_season
```

```{r}
mean(ts_airline_season$sj_hat)
```

### Seasonally adjusted series Zt Xt - st_hat

Zt = Xt = st_hat
  = mt + Wt + (st - st_hat)
  = mt + W't
  
Where W't = Wt + (st - st_hat)

```{r}
ts_airline_dec <- ts_airline_dec %>%
  mutate(Zt = Xt - st_hat)
```


### Irregular component
```{r}
ts_airline_dec <- ts_airline_dec %>%
  mutate(Wt = Zt - mt_hat)
```


### Plots
```{r}
ggplot(ts_airline_dec, aes(x = year_month, y = Xt)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_airline_dec, aes(x = year_month, y = mt_hat)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_airline_dec, aes(x = year_month, y = Yt)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_airline_dec, aes(x = year_month, y = st_hat)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_airline_dec, aes(x = year_month, y = Zt)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_airline_dec, aes(x = year_month, y = Wt)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()
```

### Classical decomposition
```{r}
classical_components <- ts_airline %>% 
  model(
    classical = classical_decomposition(
      qrt_passengers,
      type = "additive"
    )
  ) %>% 
  components()

# Plot
autoplot(classical_components)
```

## Temperature

```{r}
ts_temperature3 <- read_sav("data/Book 2/temperature3.sav") %>% 
  clean_names() %>%
    mutate(
      year_month = yearmonth(
        sprintf("%d-%02d", year, month))) %>%
  as_tsibble(index = year_month)
```


```{r}
ggplot(ts_temperature3, aes(x = year_month, y = temperature)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()
```

```{r}
weights <- c(0.5, rep(1, 11), 0.5)
weights <- weights / sum(weights)
weights
sum(weights)
```
```{r}
ts_temperature3_dec <- ts_temperature3 %>% 
  select(year, month, year_month, Xt = temperature) %>%
  mutate(
    mt_hat = slide_dbl(
      .x = Xt,
      .f = ~ weighted.mean(.x, w = weights, na.rm = TRUE),
      .before = 6,
      .after  = 6,
      .complete = TRUE),
    Yt = Xt - mt_hat) %>%
  group_by(month) %>%
  mutate(Fj = mean(Yt, na.rm = TRUE)) %>%
  ungroup()

F_bar <- ts_temperature3_dec %>% 
  distinct(month, Fj) %>% 
  summarise(F_bar = mean(Fj)) %>% 
  pull(F_bar)

ts_temperature3_dec <- ts_temperature3_dec %>%
  mutate(st_hat = Fj - F_bar)

ts_temperature3_dec %>% 
  distinct(month, st_hat) 
```

Further smoothing of seasonally adjusted plot using moving average of order 35
```{r}
ts_temperature3_dec <- ts_temperature3_dec %>%
  mutate(Zt = Xt - st_hat,
         ma35 = slide_dbl(Zt, mean, .before = 17, .after = 17, .complete = TRUE),
         Wt = Zt - ma35)
```

Seasonal component dominates, followed by random component then trend component.
```{r}
ggplot(ts_temperature3_dec, aes(x = year_month, y = Xt)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_temperature3_dec, aes(x = year_month, y = st_hat)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_temperature3_dec, aes(x = year_month, y = Zt)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_temperature3_dec, aes(x = year_month, y = mt_hat)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_temperature3_dec, aes(x = year_month, y = ma35)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()

ggplot(ts_temperature3_dec, aes(x = year_month, y = Wt)) + 
  geom_line() + 
  scale_x_yearmonth(date_breaks = "2 years", date_labels = "%Y") +
  theme_minimal()
```

# Simple exponential smoothing

## Chemical process

```{r}
ts_chemical <- read_sav("data/Book 2/chemical.sav") %>% 
  mutate(n = row_number()) %>%
  as_tsibble(index = n)
```

### Fit model
```{r}
fit_chemical <- ts_chemical %>%
  model(ses = ETS(temperature ~ error("A") + trend("N") + season("N")))
```

```{r}
components(fit_chemical)
aug_chemical <- augment(fit_chemical)
aug_chemical
```

### Multiple time plot
```{r}
fit_chemical_long <- augment(fit_chemical) %>%
  pivot_longer(cols = c(temperature, .fitted),
               names_to = "legend")

ggplot(fit_chemical_long) + 
  geom_line(aes(x = n, y = value, col = legend)) + 
  theme_minimal()
```

```{r}
tidy(fit_chemical)
```

### Goodness of fit
```{r}
glance(fit_chemical) %>% mutate(RMSE = sqrt(MSE))
```

```{r}
SSE <- sum(aug_chemical$.resid^2)
RMSE <- sqrt(mean(aug_chemical$.resid^2))
SSE
RMSE
```

Adjust for df
```{r}
n <- length(aug_chemical$.resid)
k <- 1   # one smoothing parameter, alpha; could also consider l[0], sigma^2 for ETS(A,N,N)

RMSE_df <- sqrt(sum(aug_chemical$.resid^2) / (n - k))
RMSE_df
SSE_df <- (n - k)*RMSE_df^2
SSE_df
```

```{r}
ggplot(augment(fit_chemical)) + 
  geom_line(aes(x = n, y = .innov)) + 
  theme_minimal()
```

### Ljung-Box test
```{r}
augment(fit_chemical) %>% features(.innov, ljung_box, lag = 18)
```

```{r}
e <- augment(fit_chemical)$.innov
Box.test(e, lag = 18, type = "Ljung-Box")
```
### Forecast

```{r}
future5 <- tsibble::new_data(ts_chemical, n = 5)

fit_chemical %>% forecast(new_data = future5)
```

```{r}
fc_chemical <- fit_chemical %>% 
  forecast() %>% 
  slice(1:5)

fc_chemical %>%
  hilo(level = 95) %>%
  unpack_hilo(`95%`) %>%
  mutate(lo_95 = quantile(temperature, 0.025), #Alternative approach
         hi_95 = quantile(temperature, 0.975))
```

```{r}
autoplot(fc_chemical, ts_chemical) +
  theme_minimal()
```

## Precipitation

```{r}
ts_precipitation <- read_sav("data/Book 2/Taourirt.sav") %>%
  mutate(year = 1967:1997) %>%
  as_tsibble(index = year)
```

```{r}
fit_precipitation <- ts_precipitation %>%
  model(ses = ETS(precipitation ~ error("A") + trend("N") + season("N")))
```

```{r}
fit_precipitation_long <- augment(fit_precipitation) %>%
  pivot_longer(cols = c(precipitation, .fitted),
               names_to = "legend")

ggplot(fit_precipitation_long) + 
  geom_line(aes(x = year, y = value, col = legend)) + 
  theme_minimal()
```

```{r}
tidy(fit_precipitation)
```

```{r}
glance(fit_precipitation)
```

```{r}
augment(fit_precipitation) %>% features(.innov, ljung_box, lag = 18)
```

```{r}
fc_precipitation <- fit_precipitation %>% forecast(h = 4)
fc_precipitation
```

```{r}
autoplot(fc_precipitation, ts_precipitation) + theme_minimal()
```

# Holt's exponential smoothing
## Airline passengers

Note: fourth root of passenger numbers
```{r}
ts_airline5 <- read_sav("data/Book 2/airline5.sav") %>% 
  clean_names() %>%
  as_tsibble(index = year)
```

```{r}
fit_airline5 <- ts_airline5 %>%
  model(ses = ETS(fpass ~ error("A") + trend("N") + season("N")),
        holt = ETS(fpass ~ error("A") + trend("A") + season("N")))
```

```{r}
fit_airline5_long <- augment(fit_airline5) %>%
  pivot_longer(cols = c(fpass, .fitted),
               names_to = "legend")

ggplot(fit_airline5_long) + 
  geom_line(aes(x = year, y = value, col = legend)) +
  facet_grid(vars(.model)) +
  theme_minimal()
```

```{r}
tidy(fit_airline5) %>% mutate(estimate = round(estimate, 4))
```

```{r}
glance(fit_airline5)
```

```{r}
augment(fit_airline5) %>% features(.innov, ljung_box, lag = 18)
```

```{r}
fc_airline5 <- fit_airline5 %>% 
  forecast(h = 5) %>% 
  filter(.model == "holt") %>%
  mutate(passengers = .mean^4)
fc_airline5
```
```{r}
autoplot(fc_airline5, ts_airline5) + theme_minimal()
```


## UK index of production
```{r}
ts_production <- read_sav("data/Book 2/production.sav") %>% 
  clean_names() %>%
  mutate(year_quarter = yearquarter(date)) %>%
  as_tsibble(index = year_quarter)
```

```{r}
fit_production <- ts_production %>%
  model(ses = ETS(index ~ error("A") + trend("N") + season("N")),
        holt = ETS(index ~ error("A") + trend("A") + season("N")))
```

```{r}
fit_production_long <- augment(fit_production) %>%
  pivot_longer(cols = c(index, .fitted),
               names_to = "legend")

ggplot(fit_production_long) + 
  geom_line(aes(x = year_quarter, y = value, col = legend)) +
  facet_grid(vars(.model)) +
  theme_minimal()
```

```{r}
tidy(fit_production) %>% mutate(estimate = round(estimate, 4))
```

```{r}
glance(fit_production)
```

```{r}
augment(fit_production) %>% features(.innov, ljung_box, lag = 18)
```

```{r}
fc_production <- fit_production %>% 
  forecast(h = 5) %>% 
  filter(.model == "holt")
fc_production
```

```{r}
autoplot(fc_production, ts_production)
```

# Holt-Winters' exponential smoothing
## Clostridium difficile

```{r}
ts_infections2 <- read_sav("data/Book 2/infections2.sav") %>%
  clean_names() %>%
  mutate(year_quarter = yearquarter(date)) %>%
  as_tsibble(index = year_quarter)
```

```{r}
fit_infections2 <- ts_infections2 %>%
  model(ses = ETS(clostridium ~ error("A") + trend("N") + season("N")),
        holt = ETS(clostridium ~ error("A") + trend("A") + season("N")),
        holt_wint = ETS(clostridium ~ error("A") + trend("A") + season("A")))
```

```{r}
fit_infections2_long <- augment(fit_infections2) %>%
  pivot_longer(cols = c(clostridium, .fitted),
               names_to = "legend")

ggplot(fit_infections2_long) + 
  geom_line(aes(x = year_quarter, y = value, col = legend)) +
  facet_grid(vars(.model)) +
  theme_minimal()
```

```{r}
tidy(fit_infections2) %>% mutate(estimate = round(estimate, 4))
```

```{r}
glance(fit_infections2)
```

```{r}
augment(fit_infections2) %>% features(.innov, ljung_box, lag = 18)
```

```{r}
fc_infections2 <- fit_infections2 %>% 
  forecast(h = 5) %>% 
  filter(.model == "holt_wint")
fc_infections2
```

```{r}
autoplot(fc_infections2, ts_infections2) + theme_minimal()
```

```{r}
autoplot(ts_infections2, clostridium) +
  autolayer(fitted(fit_infections2[3]), .fitted, colour = "orange") +
  autolayer(forecast(fit_infections2[3], h = 4), level = c(80, 95)) +
  theme_minimal()
```


## Electricity

```{r}
ts_electricity <- read_sav("data/Book 2/electricity.sav") %>%
  clean_names() %>%
  mutate(year_month = yearmonth(sprintf("%d-%02d", year, month)),
         logdemand = log(demand)) %>%
  as_tsibble(index = year_month)
```

```{r}
ggplot(ts_electricity, aes(x = year_month, y = demand)) + 
  geom_line() + 
  theme_minimal()

ggplot(ts_electricity, aes(x = year_month, y = logdemand)) + 
  geom_line() + 
  theme_minimal()
```

```{r}
fit_electricity <- ts_electricity %>%
  model(ses = ETS(logdemand ~ error("A") + trend("N") + season("N")),
        holt = ETS(logdemand ~ error("A") + trend("A") + season("N")),
        holt_wint = ETS(logdemand ~ error("A") + trend("A") + season("A")))
```

```{r}
fit_electricity_long <- augment(fit_electricity) %>%
  pivot_longer(cols = c(logdemand, .fitted),
               names_to = "legend")

ggplot(fit_electricity_long) + 
  geom_line(aes(x = year_month, y = value, col = legend)) +
  facet_grid(vars(.model)) +
  theme_minimal()
```

```{r}
tidy(fit_electricity) %>% mutate(estimate = round(estimate, 4))
```

```{r}
glance(fit_electricity) %>% mutate(RMSE = sqrt(MSE))
```

```{r}
augment(fit_electricity) %>% features(.innov, ljung_box, lag = 18)
```

```{r}
fc_electricity <- fit_electricity %>% 
  forecast(h = 12) %>% 
  filter(.model == "holt_wint")
fc_electricity
```

```{r}
autoplot(fc_electricity, ts_electricity) + theme_minimal()
```


# Correlograms and forecasting

## Airline passengers
```{r}
ts_airline6 <- read_sav("data/Book 2/airline6.sav") %>% 
  clean_names() %>%
  as_tsibble(index = year)
```

### ACF
```{r}
acf_airline6 <- ts_airline6 %>% ACF(error, lag_max = 20)
acf_airline6
```

```{r}
acf_airline6 %>% autoplot() + theme_minimal()
```

```{r}
ts_airline6 %>% features(error, ljung_box, lag = 20)
```


## Chemical process
```{r}
ts_chemical2 <- read_sav("data/Book 2/chemical2.sav") %>% 
  mutate(n = row_number()) %>%
  as_tsibble(index = n)
```


```{r}
acf_chemical2 <- ts_chemical2 %>% ACF(error, lag_max = 20)
acf_chemical2
```

```{r}
acf_chemical2 %>% autoplot() + theme_minimal()
```

```{r}
ts_chemical2 %>% features(error, ljung_box, lag = 20)
```

```{r}
ggplot(ts_chemical2, aes(x = error)) + 
  geom_histogram(binwidth = 4) + 
  theme_minimal()
```

## Vessel arrivals


```{r}
ts_tonnage <- read_sav("data/Book 2/tonnage.sav") %>%
  clean_names() %>%
  mutate(year_month = yearmonth(sprintf("%d-%02d", year, month))) %>%
  as_tsibble(index = year_month)
```

```{r}
ggplot(ts_tonnage, aes(x = year_month, y = tonnage)) + 
  geom_line() + 
  theme_minimal()
```

```{r}
fit_tonnage <- ts_tonnage %>%
  model(holt_wint = ETS(tonnage ~ error("A") + trend("A") + season("A")))
```

```{r}
fit_tonnage_long <- augment(fit_tonnage) %>%
  pivot_longer(cols = c(tonnage, .fitted),
               names_to = "legend")

ggplot(fit_tonnage_long) + 
  geom_line(aes(x = year_month, y = value, col = legend)) +
  facet_grid(vars(.model)) +
  theme_minimal()
```

```{r}
tidy(fit_tonnage) %>% mutate(estimate = round(estimate, 4))
```

```{r}
glance(fit_tonnage) %>% mutate(RMSE = sqrt(MSE))
```

```{r}
augment(fit_tonnage) %>% features(.innov, ljung_box, lag = 18) %>%
  mutate(across(where(is.numeric), round, 3))
```

```{r}
acf_tonnage <- augment(fit_tonnage) %>% 
  ACF(.innov, lag_max = 20)
acf_tonnage
```

```{r}
acf_tonnage %>% autoplot() + theme_minimal()
```

```{r}
ggplot(augment(fit_tonnage), aes(x = year_month, y = .innov)) + 
  geom_line() + 
  theme_minimal()
```

```{r}
ggplot(augment(fit_tonnage), aes(x = .innov)) + geom_histogram(binwidth = 250) + theme_minimal()
```

```{r}
fc_tonnage <- fit_tonnage %>% 
  forecast(h = 12)
fc_tonnage
```

```{r}
autoplot(fc_tonnage, ts_tonnage) + theme_minimal()
```


