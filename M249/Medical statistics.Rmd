---
title: "Medical statistics"
output: html_document
date: "2025-07-05"
---

```{r}
library(tidyverse)
library(janitor)
library(haven)
library(epiR)
library(DescTools)
```

# Measures of association

## Confidence intervals for relative risk

Relative risk

```{r}
a <- 1934
n1 <- 142870
c <- 2894
n2 = 392757

rr <- (a/n1)/(c/n2)

rr
```

Estimated standard error

```{r}
s <- sqrt(1/a - 1/n1 + 1/c - 1/n2)
s
```

Confidence interval

```{r}
alpha <- 0.01
z <- qnorm(1 - alpha/2)

ci <- c(rr * exp(-z * s), rr * exp(z * s))
ci
```

## Confidence intervals for odds ratio

Relative risk

```{r}
a <- 35
b <- 34
c <- 153
d <- 637

or <- (a*d)/(b*c)

or
```

Estimated standard error

```{r}
s <- sqrt(1/a + 1/b + 1/c + 1/d)
s
```

Confidence interval

```{r}
alpha <- 0.05
z <- qnorm(1 - alpha/2)

ci <- c(or * exp(-z * s), or * exp(z * s))
ci
```

## Chi-squared distribution

```{r}
df <- tibble(x = seq(0.1, 10, 0.1)) %>%
  mutate(`1` = dchisq(x, 1),
         `2` = dchisq(x, 2),
         `3` = dchisq(x, 3),
         `4` = dchisq(x, 4),
         `5` = dchisq(x, 5),) %>%
  pivot_longer(cols = -x, names_to = "df", values_to = "d")

ggplot(df, aes(x = x, y = d, group = df, colour = df)) + geom_line() + theme_minimal()
```

```{r}
ggplot(tibble(x = rnorm(100000)^2), 
       aes(x = x)) + geom_histogram(binwidth = 0.1) + scale_y_continuous(limits = c(0, 10000)) + theme_minimal()
ggplot(tibble(x = rnorm(100000)^2 + rnorm(100000)^2), 
       aes(x = x)) + geom_histogram(binwidth = 0.1) + scale_y_continuous(limits = c(0, 10000)) + theme_minimal()
ggplot(tibble(x = rnorm(100000)^2 + rnorm(100000)^2 + rnorm(100000)^2), 
       aes(x = x)) + geom_histogram(binwidth = 0.1) + scale_y_continuous(limits = c(0, 10000)) + theme_minimal()
ggplot(tibble(x = rnorm(100000)^2 + rnorm(100000)^2 + rnorm(100000)^2 + rnorm(100000)^2),
       aes(x = x)) + geom_histogram(binwidth = 0.1) + scale_y_continuous(limits = c(0, 10000)) + theme_minimal()
```

## Cross tabulation

```{r}
df_eclampsia <- tibble(count = c(327, 215, 76, 201), exposure = c(1,1,2,2), disease = c(1,2,1,2)) %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("eclampsia", "no eclampsia")),
         disease = factor(disease, levels = c(1, 2), labels = c("hypertension", "no hypertension")))
df_eclampsia
```

```{r}
tab_eclampsia <- xtabs(count ~ exposure + disease, data = df_eclampsia)
addmargins(tab_eclampsia)
```

## Cohort studies - relative risk

```{r}
df_redundancy <- read_sav("data/Book 1/redundancy.sav") %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("redundant", "not_redundant")),
         disease = factor(disease, levels = c(1, 2), labels = c("injury", "no_injury")))
```

```{r}
tab_redundancy <- xtabs(count ~ exposure + disease, data = df_redundancy)
addmargins(tab_redundancy)
```

```{r}
epi.2by2(tab_redundancy, method = "cohort.count", digits = 3)
```

## Case-control studies - odds ratio

```{r}
df_drinkdriving <- read_sav("data/Book 1/drinkdriving.sav") %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("alcohol", "no_alcohol")),
         outcome = factor(outcome, levels = c(1, 2), labels = c("killed", "not_killed")))
```

```{r}
tab_drinkdriving <- xtabs(count ~ exposure + outcome, data = df_drinkdriving)
addmargins(tab_drinkdriving)
```

```{r}
epi.2by2(tab_drinkdriving, method = "case.control", digits = 3)
```

## Chi-squared & Fisher's exact test

```{r}
tab_redundancy

chisq.test(tab_redundancy, correct = F)$expected

chisq.test(tab_redundancy, correct = F)

fisher.test(tab_redundancy)
```

```{r}
df_measles <- read_sav("data/Book 1/measlesdeath.sav") %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("after", "before")),
         disease = factor(disease, levels = c(1, 2), labels = c("died", "survived")))
```

```{r}
tab_measles <- xtabs(count ~ exposure + disease, data = df_measles)
addmargins(tab_measles)
```

```{r}
tab_measles

chisq.test(tab_measles, correct = F)$expected

chisq.test(tab_measles, correct = F)

fisher.test(tab_measles)
```

```{r}
df_asthma <- read_sav("data/Book 1/asthmagest.sav") %>%
  mutate(exposure = factor(exposure, levels = c(1, 2, 3), labels = c("pre-term", "term", "post-term")),
         disease = factor(disease, levels = c(1, 2), labels = c("hosp", "not_hosp")))
```

```{r}
tab_asthma <- xtabs(count ~ exposure + disease, data = df_asthma)
addmargins(tab_asthma)
```

```{r}
tab_asthma

chisq.test(tab_asthma, correct = F)$expected

chisq.test(tab_asthma, correct = F)

fisher.test(tab_asthma)
```

## Stratified tables

```{r}
df_kidney_stone <- tibble(
  count = c(234,36,81,6,55,25,192,71), 
  exposure = c(1,1,2,2,1,1,2,2), 
  outcome = c(1,2,1,2,1,2,1,2),
  stratum = c(1,1,1,1,2,2,2,2)) %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("keyhole surgery", "open surgery")),
         outcome = factor(outcome, levels = c(1, 2), labels = c("success", "failure")),
         stratum = factor(stratum, levels = c(1, 2), labels = c("small", "large")))
df_kidney_stone
```

```{r}
tab_kidney_stone <- xtabs(count ~ exposure + outcome + stratum, data = df_kidney_stone)

addmargins(tab_kidney_stone)
```

## Mantel-Haenszel odds ratio

```{r}
df_diabetes <- read_sav("data/Book 1/diabetes.sav") %>%
    mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("non-insulin dependent", "insulin dependent")),
         outcome = factor(outcome, levels = c(1, 2), labels = c("died", "alive")),
         stratum = factor(stratum, levels = c(1, 2), labels = c("40y or younger", "over 40y")))
```

```{r}
tab_diabetes <- xtabs(count ~ exposure + outcome + stratum, data = df_diabetes)

addmargins(tab_diabetes)
```

```{r}
epi.2by2(tab_diabetes[, , "over 40y"], method = "cohort.count", digits = 3)
```
Tests of homogeneity of the odds ratio
Breslow-Day / Tarone's test
```{r}
BreslowDayTest(tab_diabetes)
```
Tests of conditional independence
Mantel Haenszel
```{r}
mantelhaen.test(tab_diabetes)
```