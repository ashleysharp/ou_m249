---
title: "Medical statistics"
output: html_document
date: "2025-07-05"
---

```{r}
library(tidyverse)
library(janitor)
library(haven)
library(epiR)
library(DescTools)
library(glue)
```

# Measures of association

## Confidence intervals for relative risk

Relative risk

```{r}
a <- 1934
n1 <- 142870
c <- 2894
n2 = 392757

rr <- (a/n1)/(c/n2)

rr
```

Estimated standard error

```{r}
s <- sqrt(1/a - 1/n1 + 1/c - 1/n2)
s
```

Confidence interval

```{r}
alpha <- 0.01
z <- qnorm(1 - alpha/2)

ci <- c(rr * exp(-z * s), rr * exp(z * s))
ci
```

## Confidence intervals for odds ratio

Relative risk

```{r}
a <- 35
b <- 34
c <- 153
d <- 637

or <- (a*d)/(b*c)

or
```

Estimated standard error

```{r}
s <- sqrt(1/a + 1/b + 1/c + 1/d)
s
```

Confidence interval

```{r}
alpha <- 0.05
z <- qnorm(1 - alpha/2)

ci <- c(or * exp(-z * s), or * exp(z * s))
ci
```

## Chi-squared distribution

```{r}
df <- tibble(x = seq(0.1, 10, 0.1)) %>%
  mutate(`1` = dchisq(x, 1),
         `2` = dchisq(x, 2),
         `3` = dchisq(x, 3),
         `4` = dchisq(x, 4),
         `5` = dchisq(x, 5),) %>%
  pivot_longer(cols = -x, names_to = "df", values_to = "d")

ggplot(df, aes(x = x, y = d, group = df, colour = df)) + geom_line() + theme_minimal()
```

```{r}
ggplot(tibble(x = rnorm(100000)^2), 
       aes(x = x)) + geom_histogram(binwidth = 0.1) + scale_y_continuous(limits = c(0, 10000)) + theme_minimal()
ggplot(tibble(x = rnorm(100000)^2 + rnorm(100000)^2), 
       aes(x = x)) + geom_histogram(binwidth = 0.1) + scale_y_continuous(limits = c(0, 10000)) + theme_minimal()
ggplot(tibble(x = rnorm(100000)^2 + rnorm(100000)^2 + rnorm(100000)^2), 
       aes(x = x)) + geom_histogram(binwidth = 0.1) + scale_y_continuous(limits = c(0, 10000)) + theme_minimal()
ggplot(tibble(x = rnorm(100000)^2 + rnorm(100000)^2 + rnorm(100000)^2 + rnorm(100000)^2),
       aes(x = x)) + geom_histogram(binwidth = 0.1) + scale_y_continuous(limits = c(0, 10000)) + theme_minimal()
```

## Cross tabulation
### Eclampsia
```{r}
df_eclampsia <- tibble(count = c(327, 215, 76, 201), exposure = c(1,1,2,2), disease = c(1,2,1,2)) %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("eclampsia", "no eclampsia")),
         disease = factor(disease, levels = c(1, 2), labels = c("hypertension", "no hypertension")))
df_eclampsia
```

```{r}
tab_eclampsia <- xtabs(count ~ exposure + disease, data = df_eclampsia)
addmargins(tab_eclampsia)
```

## Cohort studies - relative risk

### Redundancy
```{r}
df_redundancy <- read_sav("data/Book 1/redundancy.sav") %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("redundant", "not_redundant")),
         disease = factor(disease, levels = c(1, 2), labels = c("injury", "no_injury")))
```

```{r}
tab_redundancy <- xtabs(count ~ exposure + disease, data = df_redundancy)
addmargins(tab_redundancy)
```

```{r}
epi.2by2(tab_redundancy, method = "cohort.count", digits = 3)
```

## Case-control studies - odds ratio

### Drink driving

```{r}
df_drinkdriving <- read_sav("data/Book 1/drinkdriving.sav") %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("alcohol", "no_alcohol")),
         outcome = factor(outcome, levels = c(1, 2), labels = c("killed", "not_killed")))
```

```{r}
tab_drinkdriving <- xtabs(count ~ exposure + outcome, data = df_drinkdriving)
addmargins(tab_drinkdriving)
```

```{r}
epi.2by2(tab_drinkdriving, method = "case.control", digits = 3)
```

## Chi-squared & Fisher's exact test

### Redundancy
```{r}
tab_redundancy

chisq.test(tab_redundancy, correct = F)$expected

chisq.test(tab_redundancy, correct = F)

fisher.test(tab_redundancy)
```

### Measles
```{r}
df_measles <- read_sav("data/Book 1/measlesdeath.sav") %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("after", "before")),
         disease = factor(disease, levels = c(1, 2), labels = c("died", "survived")))
```

```{r}
tab_measles <- xtabs(count ~ exposure + disease, data = df_measles)
addmargins(tab_measles)
```

```{r}
tab_measles

chisq.test(tab_measles, correct = F)$expected

chisq.test(tab_measles, correct = F)

fisher.test(tab_measles)
```

### Asthma

```{r}
df_asthma <- read_sav("data/Book 1/asthmagest.sav") %>%
  mutate(exposure = factor(exposure, levels = c(1, 2, 3), labels = c("pre-term", "term", "post-term")),
         disease = factor(disease, levels = c(1, 2), labels = c("hosp", "not_hosp")))
```

```{r}
tab_asthma <- xtabs(count ~ exposure + disease, data = df_asthma)
addmargins(tab_asthma)
```

```{r}
tab_asthma

chisq.test(tab_asthma, correct = F)$expected

chisq.test(tab_asthma, correct = F)

fisher.test(tab_asthma)
```

## Stratified tables

### Kidney stones
```{r}
df_kidney_stone <- tibble(
  count = c(234,36,81,6,55,25,192,71), 
  exposure = c(1,1,2,2,1,1,2,2), 
  outcome = c(1,2,1,2,1,2,1,2),
  stratum = c(1,1,1,1,2,2,2,2)) %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("keyhole surgery", "open surgery")),
         outcome = factor(outcome, levels = c(1, 2), labels = c("success", "failure")),
         stratum = factor(stratum, levels = c(1, 2), labels = c("small", "large")))
df_kidney_stone
```

```{r}
tab_kidney_stone <- xtabs(count ~ exposure + outcome + stratum, data = df_kidney_stone)

addmargins(tab_kidney_stone)
```

## Mantel-Haenszel odds ratio

### Diabetes
```{r}
df_diabetes <- read_sav("data/Book 1/diabetes.sav") %>%
    mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("non-insulin dependent", "insulin dependent")),
         outcome = factor(outcome, levels = c(1, 2), labels = c("died", "alive")),
         stratum = factor(stratum, levels = c(1, 2), labels = c("40y or younger", "over 40y")))
```

```{r}
tab_diabetes <- xtabs(count ~ exposure + outcome + stratum, data = df_diabetes)
addmargins(tab_diabetes)
```

```{r}
epi.2by2(tab_diabetes, method = "cohort.count", digits = 3)
```

```{r}
epi.2by2(tab_diabetes[, , "40y or younger"], method = "cohort.count", digits = 3)
epi.2by2(tab_diabetes[, , "over 40y"], method = "cohort.count", digits = 3)
```

Tests of homogeneity of the odds ratio
Breslow-Day / Tarone's test
```{r}
BreslowDayTest(tab_diabetes)
```

Tests of conditional independence
Mantel Haenszel
```{r}
mantelhaen.test(tab_diabetes)
```

### Drink driving
```{r}
df_drinkdriving2 <- read_sav("data/Book 1/drinkdriving2.sav") %>%
  mutate(exposure = factor(exposure, levels = c(1, 2), labels = c("alcohol", "no_alcohol")),
         outcome = factor(casecon, levels = c(1, 2), labels = c("killed", "not_killed")),
         stratum = factor(stratum, levels = c(1, 2), labels = c("married", "unmarried")))
```

```{r}
tab_drinkdriving2 <- xtabs(count ~ exposure + outcome + stratum, data = df_drinkdriving2)

addmargins(tab_drinkdriving2)
```

```{r}
epi.2by2(tab_drinkdriving2[,,"married"], method = "case.control", digits = 3)
epi.2by2(tab_drinkdriving2[,,"unmarried"], method = "case.control", digits = 3)
epi.2by2(tab_drinkdriving2, method = "case.control", digits = 3)
```

Tests of homogeneity of the odds ratio
Breslow-Day / Tarone's test
```{r}
BreslowDayTest(tab_drinkdriving2)
```

Tests of conditional independence
Mantel Haenszel
```{r}
mantelhaen.test(tab_drinkdriving2)
```

Married OR    16.480 (3.354, 80.970)
Unmarried OR  28.667 (5.857, 140.316)
Crude OR      25.550 (8.682, 75.189)


Breslow-Day test on Homogeneity of Odds Ratios
X-squared = 0.24307, df = 1, p-value = 0.622

M-H OR        23.001 (7.465, 70.866)
M-H X-squared = 36.604, df = 1, p-value =
1.447e-09


## Matched case-control
### Contraceptive pill
#### McNemar's test

```{r}
df_pill <- read_sav("data/Book 1/pill.sav")
```

```{r}
tab_pill <- xtabs(count ~ cases + controls, data = df_pill)

addmargins(tab_pill)
```
```{r}
mcnemar.test(tab_pill, correct = TRUE)
```
#### Mantel-Haenszel odds ratio

```{r}
z <- qnorm(0.975)

f <- tab_pill[1,2]
g <- tab_pill[2,1]

OR_hat <- f/g
OR_low <- OR_hat*exp(-z*sqrt(1/f + 1/g)) 
OR_high <- OR_hat*exp(z*sqrt(1/f + 1/g))

c(OR_low, OR_hat, OR_high)
```

### Alzheimer's

#### McNemar's test

```{r}
df_alzheimers <- read_sav("data/Book 1/Alzheimers.sav")
```

```{r}
tab_alzheimers<- xtabs(count ~ cases + controls, data = df_alzheimers)

addmargins(tab_alzheimers)
```

```{r}
mcnemar.test(tab_alzheimers, correct = TRUE)
```

#### Mantel-Haenszel odds ratio

```{r}
z <- qnorm(0.975)

f <- tab_alzheimers[1,2]
g <- tab_alzheimers[2,1]

OR_hat <- f/g
OR_low <- OR_hat*exp(-z*sqrt(1/f + 1/g)) 
OR_high <- OR_hat*exp(z*sqrt(1/f + 1/g))

c(OR_low, OR_hat, OR_high)
```


## Dose-response

### Smoking
```{r}
df_smoking2 <- read_sav("data/Book 1/smoking2.sav") %>%
  mutate(outcome = factor(casecon, levels = c(1, 2), labels = c("case", "control")))
```

```{r}
tab_smoking2 <- xtabs(count ~ dose + outcome, data = df_smoking2)

addmargins(tab_smoking2)
```

```{r}
CochranArmitageTest(tab_smoking2)
```

### PTSD
```{r}
df_ptsd <- read_sav("data/Book 1/gulfdose.sav") %>%
  mutate(outcome = factor(outcome, levels = c(1, 2), labels = c("case", "control")))
```

```{r}
tab_ptsd <- xtabs(count ~ dose + outcome, data = df_ptsd)

addmargins(tab_ptsd)
```

```{r}
CochranArmitageTest(tab_ptsd)
```


## Power

```{r}

# PARAMETERS YOU CAN ADJUST
n     <- 100
mu0   <- 0
mu1   <- 0.5
sigma <- 2
alpha <- 0.05

# Derived quantities
SE     <- sigma / sqrt(n)
lambda <- (mu1 - mu0) / SE # Non-centrality parameter
crit   <- qnorm(1 - alpha/2)

power <-
  pnorm(-crit, mean = lambda, sd = 1) + (1 - pnorm(crit, mean = lambda, sd = 1))

SE; lambda; power

```
```{r}
x <- seq(-4, 6, length.out = 2000)

df_long <- tibble(
  x = x,
  null = dnorm(x, mean = 0, sd = 1),
  alt  = dnorm(x, mean = lambda, sd = 1),
  reject_left  = x < -crit,
  reject_right = x > crit
) %>%
  pivot_longer(cols = c(null, alt),
               names_to = "distribution",
               values_to = "density")

```

```{r}
ggplot(df_long, aes(x = x, y = density, colour = distribution)) +
  
  # Curves
  geom_line(linewidth = 1.2) +
  
  # Power shading (left tail)
  geom_area(
    data = df_long %>% filter(distribution == "alt", reject_left),
    aes(fill = distribution),
    alpha = 0.25,
    colour = NA
  ) +
  
  # Power shading (right tail)
  geom_area(
    data = df_long %>% filter(distribution == "alt", reject_right),
    aes(fill = distribution),
    alpha = 0.25,
    colour = NA
  ) +
  
  # Critical values
  geom_vline(xintercept = c(-crit, crit), linetype = 2, colour = "darkred") +
  
  # Manual colours
  scale_colour_manual(
    name   = "Distribution",
    values = c(null = "#222222",
               alt  = "#0072B2")
  ) +
  scale_fill_manual(
    values = c(null = NA, alt = "#56B4E9")
  ) +
  
  # REMOVE fill legend
  guides(fill = "none") +
  
  labs(
    title = "Power Illustration on the Z Score Scale",
    subtitle = glue(
      "n = {n}, mu1 = {mu1}, sigma = {sigma}, SE = {round(SE,3)}, lambda = {round(lambda,3)}, power = {round(
        pnorm(-crit, lambda, 1) + (1 - pnorm(crit, lambda, 1)), 3)}"
    ),
    x = "Z-score",
    y = "Density"
  ) +
  
  theme_minimal(base_size = 14) +
  theme(legend.position = "top")

```

