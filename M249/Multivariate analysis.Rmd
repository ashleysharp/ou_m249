---
title: "Multivariate analysis"
output: html_document
date: "2025-07-05"
---

```{r}
library(tidyverse)
library(janitor)
library(MASS)
library(GGally)

data(iris)
```

# PCA

```{r}
X <- as.matrix(iris[, 1:4])

# --- choose: covariance PCA (center only) or correlation PCA (center + scale)
# Xc <- scale(X, center = TRUE, scale = FALSE)  # covariance version
Z  <- scale(X, center = TRUE, scale = TRUE) # correlation version

# S <- cov(Xc)               # same as t(Xc) %*% Xc / (nrow(Xc) - 1)
S <- cov(Z)

eig <- eigen(S)

values  <- eig$values      # eigenvalues (variances of PCs)
vectors <- eig$vectors     # eigenvectors (loadings)

# PC scores
scores <- Z %*% vectors

# proportion variance explained
pve <- values / sum(values)

values
pve
head(scores)

pc1 <- Z %*% vectors[,1]
pc2 <- Z %*% vectors[,1:2]
```

```{r}
X <- iris[, 1:4]

p <- prcomp(X, center = TRUE, scale. = TRUE)  # correlation PCA
summary(p)

# loadings (eigenvectors)
p$rotation

# scores
head(p$x)

# eigenvalues of correlation PCA:
(p$sdev^2)

# proportion variance explained
(p$sdev^2) / sum(p$sdev^2)
```



# Within- and between- group variance
```{r}
iris %>% mutate(sq_res = (Petal.Length - mean(Petal.Length))^2) %>%
  summarise(mean = mean(Petal.Length),
            tss = sum(sq_res),
            s2 = tss/(n()-1))
```

```{r}
iris_groups <- iris %>% group_by(Species) %>%
  mutate(sq_res = (Petal.Length - mean(Petal.Length))^2) %>%
  summarise(mean_g = mean(Petal.Length),
            ss_g = sum(sq_res), 
            s2_g = ss_g/(n()-1),
            n_g = n(),
            .groups = "drop")
iris_groups
```

```{r}
iris_w <- iris_groups %>%
  summarise(ssw = sum(ss_g), #ssw = sum((n_g-1)*s2_g),
            df = sum(n_g) - n(), #N - G
            msw = ssw/df) #Pooled within-group sample variance
iris_w
```

```{r}
grand_mean <- mean(iris$Petal.Length)
iris_b <- iris_groups %>% mutate(sq_res = n_g*(mean_g - grand_mean)^2) %>%
  summarise(ssb = sum(sq_res),
            df = n()-1,
            msb = ssb/df)
iris_b
```

```{r}
str_c("ssb = ", round(iris_b$ssb, 2),
      ", msb = ", round(iris_b$msb, 2), 
      ", ssw = ", round(iris_w$ssw, 2),
      ", msw = ", round(iris_w$msw, 2),
      ", msb/msw = ", round(iris_b$msb/iris_w$msw, 2),
      ", ss_t = ", round(iris_b$ssb + iris_w$ssw, 2))
```

```{r}
summary(aov(Petal.Length ~ Species, data = iris))
summary(aov(Petal.Width ~ Species, data = iris))
summary(aov(Sepal.Length ~ Species, data = iris))
summary(aov(Sepal.Width ~ Species, data = iris))
```

# Within- and between-group covariance

```{r message=FALSE}
ggpairs(
  iris,
  columns = 1:4,
  aes(color = Species, alpha = 0.7)
) + theme_minimal()
```


```{r}
iris %>% mutate(cp = (Sepal.Length - mean(Sepal.Length)) * (Petal.Width - mean(Petal.Width))) %>%
  summarise(scp = sum(cp), # Sum of cross products
            cov = scp/(n()-1),
            cor = cov/(sd(Sepal.Length)*sd(Petal.Width)))
```


```{r}
iris_centred <- scale(iris[, 1:4], center = TRUE, scale = FALSE)
t(iris_centred) %*% iris_centred / (nrow(iris) - 1)
#crossprod(iris_centred) / (nrow(iris) - 1)
# cov(iris[, 1:4])
```

```{r}
iris_standardised <- scale(iris[, 1:4], center = TRUE, scale = TRUE)
t(iris_standardised) %*% iris_standardised / (nrow(iris) - 1) 
# crossprod(iris_standardised) / (nrow(iris) - 1) 
# cor(iris[, 1:4])
```


```{r}
X <- as.matrix(iris[, 1:4])   # numeric variables
g <- iris$Species              # grouping factor

p <- ncol(X)
n <- nrow(X)
groups <- levels(g)
G <- length(groups)
```

```{r}
SW <- matrix(0, p, p)

for (grp in groups) {
  Xg <- X[g == grp, ]
  Xg_centered <- scale(Xg, center = TRUE, scale = FALSE)
  SW <- SW + t(Xg_centered) %*% Xg_centered
}
```

```{r}
SW_cov <- SW / (n - G)
SW_cov
```

```{r}
grand_mean <- colMeans(X)
SB <- matrix(0, p, p)

for (grp in groups) {
  Xg <- X[g == grp, ]
  ng <- nrow(Xg)
  mean_g <- colMeans(Xg)
  
  diff <- matrix(mean_g - grand_mean, ncol = 1)
  SB <- SB + ng * (diff %*% t(diff))
}
```

```{r}
SB_cov <- SB / (G - 1)
SB_cov
```

```{r}
Xc <- scale(X, center = TRUE, scale = FALSE)
ST <- t(Xc) %*% Xc

all.equal(ST, SW + SB)
```


```{r}
# Fit LDA
fit <- lda(Species ~ Sepal.Length + Sepal.Width + Petal.Length + Petal.Width,
           data = iris)

fit
# Class priors, group means, and linear discriminants (scaling)

# Predict
pred <- predict(fit, newdata = iris)
names(pred)
# "class" "posterior" "x"  (x = LD scores)

# Confusion matrix (training set)
table(Truth = iris$Species, Pred = pred$class)

# Accuracy
mean(pred$class == iris$Species)

# LD scores
head(pred$x)   # columns LD1, LD2 (since 3 classes -> at most 2 LDs)
```

```{r}
library(ggplot2)

lda_df <- data.frame(
  LD1 = pred$x[, 1],
  LD2 = pred$x[, 2],
  Species = iris$Species
)

ggplot(lda_df, aes(x = LD1, y = LD2, colour = Species)) +
  geom_point(size = 2, alpha = 0.8) +
  labs(
    x = "LD1",
    y = "LD2",
    colour = "Species"
  ) +
  theme_minimal()
```








```{r}
set.seed(123)
n <- 300

Sigma <- matrix(
  c(1.0,  0.6,  0.3,
    0.6,  1.0,  0.5,
    0.3,  0.5,  1.0),
  nrow = 3
)

dat <- mvrnorm(
  n = n,
  mu = c(0, 0, 0),
  Sigma = Sigma
)

dat <- as.data.frame(dat)
names(dat) <- c("x1", "x2", "x3")

cor(dat)
```
