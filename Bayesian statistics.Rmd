---
title: "Bayesian statistics"
output: html_document
date: "2025-07-05"
---

```{r}
library(tidyverse)
library(rjags)
library(coda)
library(glue)
```

# Standard priors

## Normal prior

```{r}
mu <- 100
sd <- sqrt(50)

pnorm(105, mu, sd) # lower.tail = TRUE
pnorm(92, mu, sd, lower.tail = FALSE) # upper tail
pnorm(105, mu, sd) - pnorm(92, mu, sd)
```

### CDF and Quantile functions

```{r}
tibble(x = seq(-3, 3, length.out = 1000)) |>
  mutate(p = pnorm(x)) %>% 
  ggplot(aes(x, p)) +
  geom_line(linewidth = 0.5) +
  theme_minimal()

tibble(p = seq(0.001, 0.999, length.out = 1000)) |>
  mutate(x = qnorm(p)) %>% 
  ggplot(aes(p, x)) +
  geom_line(linewidth = 0.5) +
  theme_minimal()
```

### Specifying using assessed values

```{r}
mode <- 20
# Assumed mode of the distribution.
# For a normal distribution, mode = mean = median,
# so this value is used as the mean.

L <- 0
U <- 43
# Supplied lower (Q1) and upper (Q3) quartiles.
# These are not necessarily symmetric about the mean
# if the asymmetry is not too severe a normal approximation should suffice

IQR <- U - L
# Interquartile range (Q3 − Q1)

a <- mode
# Mean of the normal distribution.

sd <- IQR / (2 * qnorm(0.75)) # or IQR / (qnorm(0.75) - qnorm(0.25))
# Convert IQR to standard deviation:
# IQR = 2 * z_0.75 * sd.
# Rearranging gives sd = IQR / (2 * z_0.75).

b  <- sd^2
# Variance corresponding to the derived standard deviation.

q25 <- qnorm(0.25, a, sd)
q75 <- qnorm(0.75, a, sd)

tibble(theta = seq(a - 3*IQR, a + 3*IQR, length.out = 1000)) |>
  mutate(d = dnorm(theta, mean = a, sd = sd)) |>
  ggplot(aes(theta, d)) +
  geom_line(linewidth = 0.5) +
  geom_vline(xintercept = c(q25, q75), linetype = "dashed") +
  annotate(
    "text",
    x = q25, y = Inf,
    label = paste0("Q0.25 = ", round(q25, 2)),
    vjust = 1.2,
    size = 3
  ) +
  annotate(
    "text",
    x = q75, y = Inf,
    label = paste0("Q0.75 = ", round(q75, 2)),
    vjust = 1.2,
    size = 3
  ) +
  theme_minimal()
```

## Beta prior

```{r}
a <- 4
b <- 2

mode <- (a - 1) / (a + b - 2)
s2 <- (a * b) / ((a + b)^2 * (a + b + 1))
sd <- sqrt(s2)

tibble(theta = seq(0.001, 0.999, length.out = 1000)) |>
  mutate(d = dbeta(theta, a, b)) |> 
  ggplot(aes(theta, d)) + 
  geom_line(linewidth = 0.5) +
  geom_vline(xintercept = mode, linetype = "dashed") +
  labs(
    x = expression(theta),
    y = "Density",
    subtitle = paste0(
      "Mode = ", round(mode, 3),
      ", SD = ", round(sd, 3)
    )
  ) +
  theme_minimal()
```


## Gamma prior
```{r}
a <- 6   # shape
b <- 4   # rate

mode <- (a - 1) / b
mean <- a / b
sd   <- sqrt(a) / b

tibble(theta = seq(0, 5, length.out = 1000)) |>
  mutate(d = dgamma(theta, shape = a, rate = b)) |> 
  ggplot(aes(theta, d)) + 
  geom_line(linewidth = 0.5) +
  geom_vline(xintercept = mode, linetype = "dashed") +
  geom_vline(xintercept = mean, linetype = "dotted") +
  labs(
    x = expression(theta),
    y = "Density",
    subtitle = paste0(
      "Gamma(shape = ", a, ", rate = ", b, ")  |  ",
      "Mode = ", round(mode, 3),
      ", Mean = ", round(mean, 3),
      ", SD = ", round(sd, 3)
    )
  ) +
  theme_minimal()

```

```{r}
pgamma(2, shape = 6, rate = 4)
qgamma(0.95, shape = 6, rate = 4)
```

# Likelihoods

## Normal likelihood
```{r}
n <- 10 # Number of observations
x_bar <- 30 # Sample mean
sigma2 <- 1 # Assumed known population variance
sigma <- sqrt(sigma2) # Assumed known population sd

tibble(
  theta = seq(
    x_bar - 2,
    x_bar + 2,
    length.out = 1000
  )
) |>
  mutate(
    likelihood = dnorm(x_bar, mean = theta, sd = sigma / sqrt(n))
  ) |>
  ggplot(aes(theta, likelihood)) +
  geom_line(linewidth = 0.5) +
  geom_vline(xintercept = x_bar, linetype = "dashed") +
  labs(
    title = "Normal likelihood for the mean",
    subtitle = paste0(
      "n = ", n,
      ", σ² = ", sigma2
    ),
    x = expression(theta),
    y = "Likelihood"
  ) +
  theme_minimal()

```

## Binomial likelihood
```{r}
n <- 10
x <- 2
p <- x/n

tibble(theta = seq(0, 1, length.out = 1000)) |>
  mutate(likelihood = dbinom(x, n, theta)) |> 
  # = theta^x * (1 - theta)^(n - x)
  ggplot(aes(theta, likelihood)) +
  geom_line(linewidth = 0.5) +
  geom_vline(xintercept = x / n, linetype = "dashed") +
  labs(
    title = "Binomial likelihood",
    subtitle = paste0("n = ", n, ", x = ", x, ", p = ", p),
    x = "theta",
    y = "likelihood"
  ) +
  theme_minimal()
```

## Poisson likelihood
```{r}
n <- 10
x_bar <- 2

tibble(theta = seq(0.001, 5, length.out = 1000)) |>
  mutate(
    likelihood = theta^(n * x_bar) * exp(-n * theta)
  ) |>
  ggplot(aes(theta, likelihood)) +
  geom_line(linewidth = 0.5) +
  geom_vline(xintercept = x_bar, linetype = "dashed") +
  labs(
    title = "Poisson likelihood",
    subtitle = paste0("n = ", n, ", x̄ = ", x_bar),
    x = "theta",
    y = "likelihood"
  ) +
  theme_minimal()
```

# Posteriors in conjugate models

## Normal / Normal
```{r}
# Data (summary)
n <- 15
x_bar <- 1.3
sigma2 <- 10  # known population variance
se <- sqrt(sigma2 / n)

# Prior: Normal(mu0, tau2)
mu0 <- 5
tau2 <- 4
tau <- sqrt(tau2)

# Conjugate posterior params
prec0 <- 1 / tau2
preclik <- n / sigma2

post_var <- 1 / (prec0 + preclik)
post_sd  <- sqrt(post_var)
post_mean <- post_var * (prec0 * mu0 + preclik * x_bar)

# Grid
theta_min <- min(mu0 - 5*tau, x_bar - 5*se)
theta_max <- max(mu0 + 5*tau, x_bar + 5*se)

df <- tibble(theta = seq(theta_min, theta_max, length.out = 2000)) |>
  mutate(
    dtheta = theta[2] - theta[1],  # grid spacing
    # prior density (already integrates to 1)
    prior = dnorm(theta, mean = mu0, sd = tau),
    # likelihood as a function of theta: p(x_bar | theta)
    likelihood_raw = dnorm(x_bar, mean = theta, sd = se),
    # normalise likelihood over theta so it integrates to 1 (so it can be plotted on same "density" scale)
    likelihood = likelihood_raw / sum(likelihood_raw * dtheta),
    # unnormalised posterior on the grid
    posterior_unnorm = prior * likelihood,
    # normalise posterior
    posterior = posterior_unnorm / sum(posterior_unnorm * dtheta),
    # closed-form posterior for comparison
    posterior_norm = dnorm(theta, mean = post_mean, sd = post_sd)
  )

df_long <- df |>
  select(theta, prior, likelihood, posterior) |>
  pivot_longer(-theta, names_to = "curve", values_to = "density")

ggplot(df_long, aes(theta, density, colour = curve)) +
  geom_line(linewidth = 0.6) +
  scale_colour_manual(
    values = c(
      prior = "#1f77b4",
      likelihood = "#ff7f0e",
      posterior = "#2ca02c"
    ),
    breaks = c("prior", "likelihood", "posterior"),
    labels = c(
      "Prior: Normal(5, 4)",
      "Likelihood for θ (normalised)",
      "Posterior: Normal (closed-form)"
    )
  ) +
  labs(
    title = "Prior, likelihood, and posterior for a Normal/Normal model",
    subtitle = glue("n = {n}, x̄ = {x_bar}, known σ² = {sigma2}; posterior mean = {round(post_mean, 3)}, posterior var = {round(post_var, 3)}"),
    x = "theta",
    y = "density",
    colour = NULL
  ) +
  theme_minimal()
```

## Uniform / Normal

```{r}
library(tidyverse)
library(glue)

# Data (summary)
n <- 15
x_bar <- 1.3
sigma2 <- 10  # known population variance
se <- sqrt(sigma2 / n)

# Grid (choose a sensible range around x̄)
theta_min <- x_bar - 6 * se
theta_max <- x_bar + 6 * se

df <- tibble(theta = seq(theta_min, theta_max, length.out = 2000)) |>
  mutate(
    dtheta = theta[2] - theta[1],  # grid spacing

    # Uniform prior over the grid range [theta_min, theta_max]
    prior_raw = 1,
    prior = prior_raw / sum(prior_raw * dtheta),  # makes it integrate to 1 on the grid

    # Likelihood for theta: p(x̄ | theta)
    likelihood_raw = dnorm(x_bar, mean = theta, sd = se),
    likelihood = likelihood_raw / sum(likelihood_raw * dtheta),

    # Posterior on the grid (with uniform prior this equals likelihood after normalisation)
    posterior_unnorm = prior * likelihood,
    posterior = posterior_unnorm / sum(posterior_unnorm * dtheta),

    # Closed-form posterior under an (improper) flat prior on R:
    # θ | x̄ ~ Normal(x̄, σ²/n)
    posterior_norm = dnorm(theta, mean = x_bar, sd = se)
  )

df_long <- df |>
  select(theta, prior, likelihood, posterior) |>
  pivot_longer(-theta, names_to = "curve", values_to = "density")

ggplot(df_long, aes(theta, density, colour = curve)) +
  geom_line(linewidth = 0.6) +
  scale_colour_manual(
    values = c(
      prior = "#1f77b4",
      likelihood = "#ff7f0e",
      posterior = "#2ca02c"
    ),
    breaks = c("prior", "likelihood", "posterior"),
    labels = c(
      "Prior: Uniform on grid range",
      "Likelihood for θ (normalised)",
      "Posterior (equals likelihood under flat prior)"
    )
  ) +
  labs(
    title = "Prior, likelihood, and posterior with a uniform prior",
    subtitle = glue("n = {n}, x̄ = {x_bar}, known σ² = {sigma2}; posterior mean = {x_bar}, posterior var = {round(sigma2/n, 3)}"),
    x = "theta",
    y = "density",
    colour = NULL
  ) +
  theme_minimal()
```

## Beta / Binomial

```{r}
# data
n <- 10
x <- 7

# beta prior
a <- 8
b <- 15

df <- tibble(theta = seq(0, 1, length.out = 2000)) |>
  mutate(
    dtheta = theta[2] - theta[1], # grid spacing
    prior = dbeta(theta, a, b),
    likelihood_raw = dbinom(x, size = n, prob = theta),
    # normalise likelihood so it integrates to 1
    likelihood = likelihood_raw / sum(likelihood_raw * dtheta),
    # unnormalised posterior
    posterior_unnorm = prior * likelihood,
    # normalise so it integrates to 1
    posterior = posterior_unnorm / sum(posterior_unnorm * dtheta),
    # closed-form posterior for comparison
    posterior_beta = dbeta(theta, a + x, b + (n - x))
  ) 

df_long <- df |> 
  select(theta, prior, likelihood, posterior) |>
  pivot_longer(-theta, names_to = "curve", values_to = "density")

ggplot(df_long, aes(theta, density, colour = curve)) +
  geom_line(linewidth = 0.6) +
  scale_colour_manual(
  values = c(
    prior = "#1f77b4",
    likelihood = "#ff7f0e",
    posterior = "#2ca02c"
  ),
  breaks = c("prior", "likelihood", "posterior"),
  labels = c(
    "Prior: Beta(a,b)",
    "Likelihood (normalised)",
    "Posterior: Beta(a+x, b+n-x)"
  )
) +
  labs(
    title = "Prior, likelihood, and posterior for a binomial model",
    subtitle = str_glue(
      "n = {n}, x = {x}; likelihood normalised via ∑ L(p)·Δp"
    ),
    x = "theta",
    y = "density",
    colour = NULL
  ) +
  theme_minimal()
```

## Gamma / Poisson

```{r}
# Data (summary)
n <- 8
x_bar <- 0.75        # sample mean
s <- n * x_bar    # total count (sufficient statistic)

# Gamma prior (shape, rate)
alpha <- 1.5
beta <- 0.5

df <- tibble(theta = seq(0.001, 6, length.out = 2000)) |>
  mutate(
    dtheta = theta[2] - theta[1],  # grid spacing
    # prior
    prior = dgamma(theta, shape = alpha, rate = beta),
    # likelihood for θ given (n, x̄)
    # kernel of Poisson likelihood: θ^(n x̄) exp(-n θ)
    likelihood_raw = theta^(n * x_bar) * exp(-n * theta),
    # normalise likelihood so it integrates to 1 (for plotting)
    likelihood = likelihood_raw / sum(likelihood_raw * dtheta),
    # unnormalised posterior
    posterior_unnorm = prior * likelihood,
    # normalise posterior
    posterior = posterior_unnorm / sum(posterior_unnorm * dtheta),
    # closed-form posterior for comparison
    posterior_gamma = dgamma(
      theta,
      shape = alpha + n * x_bar,
      rate  = beta + n
    )
  )

df_long <- df |>
  select(theta, prior, likelihood, posterior) |>
  pivot_longer(-theta, names_to = "curve", values_to = "density")

ggplot(df_long, aes(theta, density, colour = curve)) +
  geom_line(linewidth = 0.6) +
  scale_colour_manual(
    values = c(
      prior = "#1f77b4",
      likelihood = "#ff7f0e",
      posterior = "#2ca02c"
    ),
    breaks = c("prior", "likelihood", "posterior"),
    labels = c(
      "Prior: Gamma(α, β)",
      "Likelihood (normalised)",
      "Posterior: Gamma(α + n x̄, β + n)"
    )
  ) +
  labs(
    title = "Prior, likelihood, and posterior for a Gamma–Poisson model",
    subtitle = str_glue(
      "n = {n}, x̄ = {x_bar}, total = n x̄ = {s}"
    ),
    x = "theta",
    y = "density",
    colour = NULL
  ) +
  theme_minimal()
```

