---
title: "Bayesian statistics"
output: html_document
date: "2025-07-05"
---

```{r}
library(tidyverse)
library(runjags)
library(coda)
```

# Baysean analysis for a proportion

## Likelihood for a proportion
```{r}
n <- 50
x <- 11

tibble(theta = seq(0, 1, length.out = 1000)) |>
  mutate(likelihood = dbinom(x, n, theta)) |> 
  # = theta^x * (1 - theta)^(n - x)
  ggplot(aes(theta, likelihood)) +
  geom_line(linewidth = 0.5) +
  geom_vline(xintercept = x / n, linetype = "dashed") +
  labs(
    title = "Binomial likelihood",
    subtitle = paste0("n = ", n, ", x = ", x),
    x = "theta",
    y = "likelihood"
  ) +
  theme_minimal()
```

## Posterior for a proportion

```{r}
# data
n <- 9
x <- 6

# beta prior
a <- 2
b <- 6

df <- tibble(theta = seq(0, 1, length.out = 2000)) |>
  mutate(
    dtheta = theta[2] - theta[1], # grid spacing
    prior = dbeta(theta, a, b),
    likelihood_raw = dbinom(x, size = n, prob = theta),
    # normalise likelihood so it integrates to 1
    likelihood = likelihood_raw / sum(likelihood_raw * dtheta),
    # unnormalised posterior
    posterior_unnorm = prior * likelihood,
    # normalise so it integrates to 1
    posterior = posterior_unnorm / sum(posterior_unnorm * dtheta),
    # closed-form posterior for comparison
    posterior_beta = dbeta(theta, a + x, b + (n - x))
  ) 

df_long <- df |> 
  select(theta, prior, likelihood, posterior) |>
  pivot_longer(-theta, names_to = "curve", values_to = "density")

ggplot(df_long, aes(theta, density, colour = curve)) +
  geom_line(linewidth = 0.6) +
  scale_colour_manual(
  values = c(
    prior = "#1f77b4",
    likelihood = "#ff7f0e",
    posterior = "#2ca02c"
  ),
  breaks = c("prior", "likelihood", "posterior"),
  labels = c(
    "Prior: Beta(a,b)",
    "Likelihood (normalised)",
    "Posterior: Beta(a+x, b+n-x)"
  )
) +
  labs(
    title = "Prior, likelihood, and posterior for a binomial model",
    subtitle = str_glue(
      "n = {n}, x = {x}; likelihood normalised via ∑ L(p)·Δp"
    ),
    x = "theta",
    y = "density",
    colour = NULL
  ) +
  theme_minimal()
```

# Standard priors

## Normal prior

```{r}
mu <- 100
sd <- sqrt(50)

pnorm(105, mu, sd) # lower.tail = TRUE
pnorm(92, mu, sd, lower.tail = FALSE) # upper tail
pnorm(105, mu, sd) - pnorm(92, mu, sd)
```

### CDF and Quantile functions

```{r}
tibble(x = seq(-3, 3, length.out = 1000)) |>
  mutate(p = pnorm(x)) %>% 
  ggplot(aes(x, p)) +
  geom_line(linewidth = 0.5) +
  theme_minimal()

tibble(p = seq(0.001, 0.999, length.out = 1000)) |>
  mutate(x = qnorm(p)) %>% 
  ggplot(aes(p, x)) +
  geom_line(linewidth = 0.5) +
  theme_minimal()
```

### Specifying using assessed values

```{r}
mode <- 20
# Assumed mode of the distribution.
# For a normal distribution, mode = mean = median,
# so this value is used as the mean.

L <- 0
U <- 43
# Supplied lower (Q1) and upper (Q3) quartiles.
# These are not necessarily symmetric about the mean
# if the asymmetry is not too severe a normal approximation should suffice

IQR <- U - L
# Interquartile range (Q3 − Q1)

a <- mode
# Mean of the normal distribution.

sd <- IQR / (2 * qnorm(0.75)) # or IQR / (qnorm(0.75) - qnorm(0.25))
# Convert IQR to standard deviation:
# IQR = 2 * z_0.75 * sd.
# Rearranging gives sd = IQR / (2 * z_0.75).

b  <- sd^2
# Variance corresponding to the derived standard deviation.

q25 <- qnorm(0.25, a, sd)
q75 <- qnorm(0.75, a, sd)

tibble(theta = seq(a - 3*IQR, a + 3*IQR, length.out = 1000)) |>
  mutate(d = dnorm(theta, mean = a, sd = sd)) |>
  ggplot(aes(theta, d)) +
  geom_line(linewidth = 0.5) +
  geom_vline(xintercept = c(q25, q75), linetype = "dashed") +
  annotate(
    "text",
    x = q25, y = Inf,
    label = paste0("Q0.25 = ", round(q25, 2)),
    vjust = 1.2,
    size = 3
  ) +
  annotate(
    "text",
    x = q75, y = Inf,
    label = paste0("Q0.75 = ", round(q75, 2)),
    vjust = 1.2,
    size = 3
  ) +
  theme_minimal()
```

## Beta prior

```{r}
a <- 25
b <- 5

mode <- (a - 1) / (a + b - 2)
s2 <- (a * b) / ((a + b)^2 * (a + b + 1))
sd <- sqrt(s2)

tibble(theta = seq(0.001, 0.999, length.out = 1000)) |>
  mutate(d = dbeta(theta, a, b)) |> 
  ggplot(aes(theta, d)) + 
  geom_line(linewidth = 0.5) +
  geom_vline(xintercept = mode, linetype = "dashed") +
  labs(
    x = expression(theta),
    y = "Density",
    subtitle = paste0(
      "Mode = ", round(mode, 3),
      ", SD = ", round(sd, 3)
    )
  ) +
  theme_minimal()
```

